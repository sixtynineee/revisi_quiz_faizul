// app.js for result.html
(function(){
  const resultSummary = document.getElementById('resultSummary');
  const detailedResults = document.getElementById('detailedResults');
  const themeToggle3 = document.getElementById('themeToggle3');

  function escapeHtml(s){ if (s==null) return ""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'", "&#039;"); }

  // get payload from sessionStorage (preferred) or localStorage fallback
  let payload = null;
  try {
    const raw = sessionStorage.getItem('quiz_result_payload');
    if (raw) { payload = JSON.parse(raw); }
  } catch(e){ console.warn(e); }

  if (!payload){
    try {
      const raw2 = localStorage.getItem('last_quiz_result_v1');
      if (raw2) payload = JSON.parse(raw2);
    } catch(e){}
  }

  if (!payload){
    resultSummary.innerHTML = '<div class="muted">Tidak ada data hasil. Kembali ke daftar untuk mengerjakan kuis.</div>';
    detailedResults.innerHTML = '';
    return;
  }

  // summary
  resultSummary.innerHTML = `<div style="margin-bottom:8px"><strong>${escapeHtml(payload.courseName || payload.courseId || 'Quiz')}</strong></div>
    <div><b>${payload.correct} / ${payload.totalQuestions}</b> soal benar</div>
    <div class="muted" style="margin-top:6px">${new Date(payload.timestamp).toLocaleString()}</div>`;

  // detailed list
  const out = [];
  payload.answers.forEach((a, i) => {
    const userIdx = a.userAnswerIndex;
    const corr = a.correctIndex;
    const isCorrect = userIdx === corr;
    const optHtml = a.options.map((t, j) => {
      const cls = j === corr ? 'final-correct' : (userIdx === j && userIdx !== corr ? 'final-wrong' : '');
      return `<div class="choice ${cls}" style="margin-bottom:6px"><span class="label">${["A","B","C","D","E"][j]||(j+1)+'.'}</span> <span class="text">${escapeHtml(t)}</span></div>`;
    }).join('');
    out.push(`
      <div class="question-card" style="margin-bottom:12px">
        <div class="q-text"><b>${i+1}.</b> ${escapeHtml(a.question)}</div>
        <div style="margin-top:8px">${optHtml}</div>
        <div class="explanation muted" style="margin-top:8px"><strong>Penjelasan:</strong> ${escapeHtml(a.explanation || 'Tidak ada')}</div>
      </div>
    `);
  });

  detailedResults.innerHTML = out.join('');

  // theme toggle
  if (themeToggle3){
    themeToggle3.onclick = () => {
      document.documentElement.classList.toggle('dark-mode');
      try { localStorage.setItem('darkMode', document.documentElement.classList.contains('dark-mode')); } catch(e){}
    };
    try { if (localStorage.getItem('darkMode') === 'true') document.documentElement.classList.add('dark-mode'); } catch(e){}
  }
})();
